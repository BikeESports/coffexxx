<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CoffeXXX - Panel admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/webp" href="logocoffexxx.webp">

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617;
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* LOGIN SCREEN */
    #loginScreen {
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .login-card {
      width:100%;
      max-width:360px;
      background:#020617;
      border-radius:16px;
      border:1px solid rgba(30,64,175,0.7);
      padding:18px 16px 16px;
      box-shadow:0 18px 40px rgba(15,23,42,0.75);
    }

    .login-logo {
      display:block;
      margin:0 auto 8px;
      width:80px;
      height:auto;
      mix-blend-mode:lighten;
      -webkit-user-drag:none;
      user-select:none;
    }

    .login-title {
      text-align:center;
      font-size:1.05rem;
      font-weight:600;
      margin-bottom:4px;
    }

    .login-subtitle {
      text-align:center;
      font-size:0.8rem;
      color:rgba(148,163,184,0.95);
      margin-bottom:12px;
    }

    .login-field {
      margin-bottom:8px;
      font-size:0.8rem;
    }

    .login-field label {
      display:block;
      margin-bottom:3px;
      color:rgba(226,232,240,0.95);
    }

    .login-input {
      width:100%;
      padding:7px 9px;
      border-radius:8px;
      border:1px solid rgba(148,163,184,0.9);
      background:#020617;
      color:#e5e7eb;
      font-size:0.85rem;
      outline:none;
    }

    .login-btn {
      margin-top:10px;
      width:100%;
      padding:8px 12px;
      border-radius:999px;
      border:none;
      font-size:0.9rem;
      font-weight:500;
      cursor:pointer;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#020617;
    }

    .login-error {
      margin-top:8px;
      font-size:0.78rem;
      color:#f97373;
      min-height:16px;
    }

    .login-note {
      margin-top:8px;
      font-size:0.7rem;
      color:rgba(148,163,184,0.9);
      text-align:center;
    }

    /* ADMIN APP */
    #adminApp {
      display:none;
      min-height:100vh;
      flex-direction:column;
    }

    header {
      padding:14px 16px;
      border-bottom:1px solid rgba(30,64,175,0.6);
      background:#020617;
      display:flex;
      align-items:center;
      gap:12px;
    }

    header img.logo {
      width:42px;
      height:auto;
      mix-blend-mode:lighten;
      -webkit-user-drag:none;
      user-select:none;
    }

    header h1 {
      font-size:1.1rem;
      margin:0;
    }

    header p {
      margin:2px 0 0;
      font-size:0.78rem;
      color:rgba(148,163,184,0.95);
    }

    main {
      flex:1;
      padding:12px 10px 20px;
      max-width:1100px;
      width:100%;
      margin:0 auto;
    }

    .status-bar {
      font-size:0.8rem;
      margin-bottom:10px;
      color:rgba(148,163,184,0.95);
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .badge-env {
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      font-size:0.7rem;
      color:rgba(148,163,184,0.95);
      letter-spacing:0.08em;
      text-transform:uppercase;
    }

    .btn {
      padding:6px 12px;
      border-radius:999px;
      border:none;
      font-size:0.75rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .btn-refresh { background:#0ea5e9; color:#0b1120; }
    .btn-logout { background:#ef4444; color:#fef2f2; }

    .btn-small {
      padding:4px 8px;
      border-radius:999px;
      border:none;
      font-size:0.74rem;
      cursor:pointer;
      margin:2px 0;
    }

    .btn-unlock { background:#22c55e; color:#022c22; }
    .btn-lock { background:#f97316; color:#1f2933; }
    .btn-copy-id { background:#111827; color:#e5e7eb;border:1px solid rgba(55,65,81,0.9); }
    .btn-view-doc { background:#0ea5e9; color:#02273b; }

    .table-wrapper {
      overflow:auto;
      max-height:70vh;
      border-radius:10px;
      border:1px solid rgba(30,64,175,0.7);
      background:#020617;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:0.78rem;
    }

    thead {
      position:sticky;
      top:0;
      background:#020617;
      z-index:2;
    }

    th,td {
      padding:6px 6px;
      border-bottom:1px solid rgba(30,64,175,0.45);
      vertical-align:top;
    }

    th {
      text-align:left;
      font-weight:600;
      color:rgba(191,219,254,0.95);
    }

    tr:nth-child(even) td { background:rgba(15,23,42,0.98); }
    tr:nth-child(odd) td { background:rgba(15,23,42,0.92); }

    .mono {
      font-family:monospace;
      font-size:0.7rem;
      word-break:break-all;
    }

    .badge {
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      border-radius:999px;
      font-size:0.7rem;
      border:1px solid rgba(148,163,184,0.8);
      gap:4px;
    }

    .badge-pend { background:#fbbf24; color:#451a03; }
    .badge-ok { background:#22c55e; color:#022c22; }
    .badge-origin { background:#1d4ed8; color:#e0ecff; }
    .badge-amount { background:#0d9488; color:#ccfbf1; }

    .small-note {
      margin-top:10px;
      font-size:0.7rem;
      color:rgba(148,163,184,0.9);
    }

    footer {
      padding:10px;
      text-align:center;
      font-size:0.7rem;
      color:rgba(148,163,184,0.95);
      border-top:1px solid rgba(30,64,175,0.5);
      background:#020617;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <img src="logocoffexxx.webp" class="login-logo" alt="CoffeXXX">

    <div class="login-title">Panel admin CoffeXXX</div>
    <div class="login-subtitle">IngresÃ¡ con tu correo y contraseÃ±a de administrador.</div>

    <form id="loginForm" autocomplete="off">
      <div class="login-field">
        <label for="loginEmail">Correo</label>
        <input id="loginEmail"
               class="login-input"
               type="email"
               autocomplete="off"
               autocorrect="off"
               autocapitalize="none"
               spellcheck="false"
               placeholder=""
               required>
      </div>

      <div class="login-field">
        <label for="loginPassword">ContraseÃ±a</label>
        <input id="loginPassword"
               class="login-input"
               type="password"
               autocomplete="new-password"
               placeholder=""
               required>
      </div>

      <button type="submit" class="login-btn">Entrar al panel</button>
      <div id="loginError" class="login-error"></div>

      <div class="login-note">
        No uses esta contraseÃ±a como clave real de tu correo.  
        Es solo para este panel.
      </div>
    </form>
  </div>
</div>

<!-- APP -->
<div id="adminApp">
  <header>
    <img src="logocoffexxx.webp" class="logo" alt="CoffeXXX">
    <div>
      <h1>Panel admin CoffeXXX</h1>
      <p>GestionÃ¡ las suscripciones y desbloqueÃ¡ el contenido.</p>
    </div>
  </header>

  <main>

    <div class="status-bar">
      <div>
        <strong>Estado:</strong> <span id="adminStatus">Conectando...</span>
      </div>
      <div>
        <span class="badge-env">CoffeXXX</span>
        <button class="btn btn-refresh" onclick="manualRefresh()">ðŸ”„ Actualizar</button>
        <button class="btn btn-logout" onclick="logout()">ðŸšª Cerrar sesiÃ³n</button>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Contacto</th>
            <th>Comprobante</th>
            <th>Origen / Monto</th>
            <th>Estado</th>
            <th>Acciones</th>
            <th>ID</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="small-note">
      Al desbloquear, el cliente verÃ¡ el contenido en el navegador donde hizo la solicitud.
    </div>

  </main>

  <footer>CoffeXXX Â· Panel interno</footer>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  /* LOGIN CONFIG (solo panel, no es tu Gmail real) */
  const ADMIN_EMAIL = "agustindentella68@gmail.com";
  const ADMIN_PASS  = "919111sofixxx";

  /* FIREBASE */
  const firebaseConfig = {
    apiKey: "AIzaSyDnQKrLuArSTWwg98T5sBCPQuP7yWg5zUc",
    authDomain: "coffexxx-admin.firebaseapp.com",
    projectId: "coffexxx-admin",
    storageBucket: "coffexxx-admin.firebasestorage.app",
    messagingSenderId: "669030910916",
    appId: "1:669030910916:web:e170abf4663aec7bb1f291",
    measurementId: "G-7XR9SB1BGZ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const loginScreen = document.getElementById("loginScreen");
  const adminApp    = document.getElementById("adminApp");
  const loginForm   = document.getElementById("loginForm");
  const loginError  = document.getElementById("loginError");
  const adminStatus = document.getElementById("adminStatus");
  const tableBody   = document.getElementById("tableBody");

  let unsubscribe = null;

  /* LOGIN */
  loginForm.addEventListener("submit", e => {
    e.preventDefault();
    const emailInput = document.getElementById("loginEmail").value.trim();
    const passInput  = document.getElementById("loginPassword").value;

    if (emailInput === ADMIN_EMAIL && passInput === ADMIN_PASS) {
      loginError.textContent = "";
      loginScreen.style.display = "none";
      adminApp.style.display = "flex";
      startListener();
    } else {
      loginError.textContent = "Correo o contraseÃ±a incorrectos.";
    }
  });

  function logout() {
    if (unsubscribe) unsubscribe();
    adminApp.style.display = "none";
    loginScreen.style.display = "flex";
    loginForm.reset();
    loginError.textContent = "";
  }

  /* FIRESTORE */
  function formatDate(ts) {
    if (!ts || !ts.toDate) return "-";
    try { return ts.toDate().toLocaleString("es-AR"); }
    catch { return "-"; }
  }

  function renderSnapshot(snapshot) {
    tableBody.innerHTML = "";
    if (snapshot.empty) {
      tableBody.innerHTML = "<tr><td colspan='8'>No hay solicitudes.</td></tr>";
      return;
    }

    snapshot.forEach(doc => {
      const d = doc.data();

      const fecha = formatDate(d.creado);
      const nombre = d.nombre || "";
      const contacto = d.contacto || "";
      const origen = d.origen || "CoffeXXX";
      const monto = d.monto || 0;
      const moneda = d.moneda || "ARS";
      const desbloqueado = !!d.desbloqueado;

      const comprobanteNombre = d.comprobanteNombre || "(sin nombre)";
      const comprobanteUrl = d.comprobanteUrl || null;

      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${fecha}</td>
        <td>${nombre}</td>
        <td>${contacto}</td>
        <td>
          ${comprobanteUrl
            ? `<button class="btn-small btn-view-doc" onclick="openComprobante('${encodeURI(comprobanteUrl)}')">
                 Ver comprobante
               </button><br><span class="mono">${comprobanteNombre}</span>`
            : `<span class="mono">Sin archivo</span>`}
        </td>
        <td>
          <span class="badge badge-origin">${origen}</span><br>
          <span class="badge badge-amount">${monto.toLocaleString("es-AR")} ${moneda}</span>
        </td>
        <td>
          <span class="badge ${desbloqueado ? "badge-ok" : "badge-pend"}">
            ${desbloqueado ? "Desbloqueado" : "Pendiente"}
          </span>
        </td>
        <td>
          ${desbloqueado
            ? `<button class="btn-small btn-lock" onclick="setUnlocked('${doc.id}', false)">Bloquear</button>`
            : `<button class="btn-small btn-unlock" onclick="setUnlocked('${doc.id}', true)">Desbloquear</button>`}
        </td>
        <td class="mono">
          ${doc.id}<br>
          <button class="btn-small btn-copy-id" onclick="copyId('${doc.id}')">copiar</button>
        </td>
      `;

      tableBody.appendChild(tr);
    });
  }

  function startListener() {
    if (unsubscribe) unsubscribe();
    adminStatus.textContent = "Escuchando suscripciones...";
    unsubscribe = db.collection("suscripciones")
      .orderBy("creado","desc")
      .onSnapshot(
        snap => renderSnapshot(snap),
        err => {
          console.error(err);
          adminStatus.textContent = "Error al escuchar datos.";
        }
      );
  }

  async function manualRefresh() {
    try {
      adminStatus.textContent = "Actualizando...";
      const snap = await db.collection("suscripciones").orderBy("creado","desc").get();
      renderSnapshot(snap);
      adminStatus.textContent = "Listado actualizado.";
    } catch (err) {
      console.error(err);
      adminStatus.textContent = "Error al actualizar.";
    }
  }

  async function setUnlocked(id, val) {
    try {
      await db.collection("suscripciones").doc(id).update({ desbloqueado: val });
      adminStatus.textContent = val ? "SuscripciÃ³n desbloqueada âœ“" : "SuscripciÃ³n bloqueada.";
    } catch (err) {
      console.error(err);
      adminStatus.textContent = "Error al cambiar el estado.";
    }
  }

  function copyId(id) {
    navigator.clipboard.writeText(id).then(() => {
      adminStatus.textContent = "ID copiado.";
    }).catch(() => {
      adminStatus.textContent = "No se pudo copiar el ID.";
    });
  }

  function openComprobante(url) {
    try {
      window.open(url, "_blank");
    } catch (e) {
      console.error(e);
      adminStatus.textContent = "No se pudo abrir el comprobante.";
    }
  }

  // Exponer funciones a window para usarlas en los onclick
  window.manualRefresh   = manualRefresh;
  window.setUnlocked     = setUnlocked;
  window.copyId          = copyId;
  window.openComprobante = openComprobante;
  window.logout          = logout;
</script>

</body>
</html>
