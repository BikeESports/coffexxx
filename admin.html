<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CoffeXXX - Panel admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon (mismo logo) -->
  <link rel="icon" type="image/webp" href="logocoffexxx.webp">

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617;
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header {
      padding:14px 16px;
      border-bottom:1px solid rgba(30,64,175,0.6);
      background:#020617;
      display:flex;
      align-items:center;
      gap:12px;
    }

    header img.logo {
      width:42px;
      height:auto;
      mix-blend-mode:lighten;
      -webkit-user-drag:none;
      user-select:none;
    }

    header h1 {
      font-size:1.1rem;
      margin:0;
    }

    header p {
      margin:2px 0 0;
      font-size:0.78rem;
      color:rgba(148,163,184,0.95);
    }

    main {
      flex:1;
      padding:12px 10px 20px;
      max-width:1100px;
      width:100%;
      margin:0 auto;
    }

    .status-bar {
      font-size:0.8rem;
      margin-bottom:10px;
      color:rgba(148,163,184,0.95);
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .status-left span.label {
      font-weight:500;
    }

    .status-right {
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .badge-env {
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:rgba(148,163,184,0.95);
    }

    .btn {
      padding:5px 10px;
      border-radius:999px;
      border:none;
      font-size:0.75rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .btn-refresh {
      background:#0ea5e9;
      color:#0b1120;
    }

    .btn-small {
      padding:4px 8px;
      border-radius:999px;
      border:none;
      font-size:0.75rem;
      cursor:pointer;
      margin:2px 0;
    }

    .btn-unlock {
      background:#22c55e;
      color:#022c22;
    }

    .btn-lock {
      background:#ef4444;
      color:#fef2f2;
    }

    .btn-copy-id {
      background:#111827;
      color:#e5e7eb;
      border:1px solid rgba(55,65,81,0.9);
    }

    .table-wrapper {
      overflow:auto;
      max-height:70vh;
      border-radius:10px;
      border:1px solid rgba(30,64,175,0.7);
      background:#020617;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:0.78rem;
    }

    thead {
      position:sticky;
      top:0;
      z-index:2;
      background:#020617;
    }

    th, td {
      padding:6px 6px;
      border-bottom:1px solid rgba(30,64,175,0.45);
      vertical-align:top;
    }

    th {
      text-align:left;
      font-weight:600;
      color:rgba(191,219,254,0.95);
      background:#020617;
    }

    tr:nth-child(even) td {
      background:rgba(15,23,42,0.98);
    }

    tr:nth-child(odd) td {
      background:rgba(15,23,42,0.92);
    }

    .mono {
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:0.7rem;
      word-break:break-all;
    }

    .badge {
      display:inline-flex;
      align-items:center;
      padding:2px 7px;
      border-radius:999px;
      font-size:0.7rem;
      border:1px solid rgba(148,163,184,0.8);
      gap:4px;
      white-space:nowrap;
    }

    .badge-pend {
      background:#fbbf24;
      color:#451a03;
      border-color:rgba(254,243,199,0.9);
    }

    .badge-ok {
      background:#22c55e;
      color:#022c22;
      border-color:rgba(187,247,208,0.9);
    }

    .badge-origin {
      background:rgba(30,64,175,0.8);
      color:#e0ecff;
      border-color:rgba(129,140,248,0.9);
    }

    .badge-amount {
      background:rgba(15,118,110,0.85);
      color:#ccfbf1;
      border-color:rgba(45,212,191,0.9);
    }

    .small-note {
      margin-top:6px;
      font-size:0.7rem;
      color:rgba(148,163,184,0.9);
    }

    footer {
      padding:10px;
      text-align:center;
      font-size:0.7rem;
      color:rgba(148,163,184,0.95);
      border-top:1px solid rgba(30,64,175,0.5);
      background:#020617;
    }
  </style>
</head>
<body>

<header>
  <img src="logocoffexxx.webp" class="logo" alt="CoffeXXX">
  <div>
    <h1>Panel admin CoffeXXX</h1>
    <p>Gestion谩 las suscripciones y desbloque谩 el contenido para cada cliente.</p>
  </div>
</header>

<main>
  <div class="status-bar">
    <div class="status-left">
      <span class="label">Estado:</span>
      <span id="adminStatus">Inicializando...</span>
    </div>
    <div class="status-right">
      <span class="badge-env">CoffeXXX 路 suscripciones</span>
      <button type="button" class="btn btn-refresh" onclick="manualRefresh()">
         Actualizar ahora
      </button>
    </div>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Contacto</th>
          <th>Pago</th>
          <th>Nota</th>
          <th>Origen</th>
          <th>Estado</th>
          <th>Acciones</th>
          <th>ID</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- filas din谩micas -->
      </tbody>
    </table>
  </div>

  <div class="small-note">
    Tip: al desbloquear, el cliente ver谩 el contenido habilitado en el navegador donde hizo la solicitud.
  </div>
</main>

<footer>
  CoffeXXX 路 Panel interno 路 No compartas este enlace.
</footer>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  //  Clave simple de acceso al panel (CAMBI ESTO)
  const ADMIN_PASS = "CoffeXXXAdmin2025";

  const pass = prompt("Clave de administrador CoffeXXX:");
  if (pass !== ADMIN_PASS) {
    document.body.innerHTML = "<div style='padding:20px;font-family:sans-serif;color:#fee2e2;background:#111827;min-height:100vh;'>Acceso denegado.</div>";
    throw new Error("Acceso denegado");
  }

  // 锔 MISMA CONFIG QUE EN index.html (COMPLETAR)
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_PROYECTO.firebaseapp.com",
    projectId: "TU_PROYECTO",
    storageBucket: "TU_PROYECTO.appspot.com",
    messagingSenderId: "XXX",
    appId: "XXX"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const adminStatus = document.getElementById("adminStatus");
  const tableBody = document.getElementById("tableBody");
  let unsubscribe = null;

  function formatDate(ts) {
    if (!ts || !ts.toDate) return "-";
    try {
      return ts.toDate().toLocaleString("es-AR");
    } catch {
      return "-";
    }
  }

  function renderSnapshot(snapshot) {
    tableBody.innerHTML = "";
    if (snapshot.empty) {
      tableBody.innerHTML = "<tr><td colspan='9'>No hay solicitudes por el momento.</td></tr>";
      return;
    }

    snapshot.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement("tr");

      const fecha = formatDate(data.creado);
      const nombre = data.nombre || "";
      const contacto = data.contacto || "";
      const email = data.email || "";
      const comprobante = data.comprobante || "";
      const nota = data.nota || "";
      const origen = data.origen || "CoffeXXX";
      const monto = data.monto || 0;
      const moneda = data.moneda || "ARS";
      const desbloqueado = !!data.desbloqueado;

      tr.innerHTML = `
        <td>${fecha}</td>
        <td>${nombre}</td>
        <td>
          ${contacto ? contacto : ""}
          ${email ? `<br><span class="mono">${email}</span>` : ""}
        </td>
        <td>
          <span class="mono">${comprobante || "-"}</span>
          <br>
          <span class="badge badge-amount">${monto.toLocaleString("es-AR")} ${moneda}</span>
        </td>
        <td>${nota ? nota : "-"}</td>
        <td>
          <span class="badge badge-origin">${origen}</span>
        </td>
        <td>
          <span class="badge ${desbloqueado ? "badge-ok" : "badge-pend"}">
            ${desbloqueado ? "Desbloqueado" : "Pendiente"}
          </span>
        </td>
        <td>
          ${
            desbloqueado
              ? `<button class="btn-small btn-lock" onclick="setUnlocked('${doc.id}', false)">Volver a bloquear</button>`
              : `<button class="btn-small btn-unlock" onclick="setUnlocked('${doc.id}', true)">Desbloquear</button>`
          }
        </td>
        <td class="mono">
          ${doc.id}
          <br>
          <button class="btn-small btn-copy-id" onclick="copyId('${doc.id}')">copiar</button>
        </td>
      `;

      tableBody.appendChild(tr);
    });
  }

  function startListener() {
    if (unsubscribe) unsubscribe();
    adminStatus.textContent = "Escuchando suscripciones en tiempo real...";
    unsubscribe = db.collection("suscripciones")
      .orderBy("creado", "desc")
      .onSnapshot(
        snapshot => {
          renderSnapshot(snapshot);
        },
        err => {
          console.error(err);
          adminStatus.textContent = "Error al escuchar los datos.";
        }
      );
  }

  async function manualRefresh() {
    try {
      adminStatus.textContent = "Actualizando...";
      const snapshot = await db.collection("suscripciones")
        .orderBy("creado", "desc")
        .get();
      renderSnapshot(snapshot);
      adminStatus.textContent = "Listado actualizado.";
    } catch (err) {
      console.error(err);
      adminStatus.textContent = "Error al actualizar.";
    }
  }

  async function setUnlocked(id, value) {
    try {
      await db.collection("suscripciones").doc(id).update({
        desbloqueado: value
      });
      adminStatus.textContent = value
        ? "Suscripci贸n desbloqueada: el cliente ya puede ver el contenido."
        : "Suscripci贸n bloqueada nuevamente.";
    } catch (err) {
      console.error(err);
      adminStatus.textContent = "Error al cambiar el estado.";
    }
  }

  function copyId(id) {
    navigator.clipboard.writeText(id).then(() => {
      adminStatus.textContent = "ID copiado al portapapeles.";
    }).catch(() => {
      adminStatus.textContent = "No se pudo copiar el ID.";
    });
  }

  // Exponer funciones al scope global
  window.manualRefresh = manualRefresh;
  window.setUnlocked = setUnlocked;
  window.copyId = copyId;

  // Iniciar listener en cuanto carga
  startListener();
</script>

</body>
</html>
