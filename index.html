<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CoffeXXX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/webp" href="logocoffexxx.webp">

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617;
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header {
      padding:16px 20px;
      text-align:center;
      border-bottom:1px solid rgba(30,64,175,0.5);
    }

    header img.logo {
      width:130px;
      height:auto;
      margin:0 auto 10px;
      mix-blend-mode:lighten;
      display:block;
      -webkit-user-drag:none;
      user-select:none;
    }

    header h1 {
      font-size:1.3rem;
      font-weight:600;
      margin-bottom:4px;
    }

    header p {
      font-size:0.85rem;
      color:rgba(148,163,184,0.95);
    }

    main {
      width:100%;
      max-width:900px;
      margin:0 auto;
      padding:20px 12px 50px;
    }

    .section-title {
      font-size:1.1rem;
      margin-bottom:10px;
      font-weight:600;
      color:#e2e8f0;
    }

    /* GALERÍA */
    .grid {
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
      gap:12px;
    }

    .thumb {
      position:relative;
      width:100%;
      height:240px;
      border-radius:12px;
      overflow:hidden;
      background:#0f172a;
    }

    .thumb-inner {
      width:100%;
      height:100%;
      background-size:cover;
      background-position:center;
      filter:blur(22px) brightness(0.35);
      transition:0.25s ease;
    }

    .thumb.unlocked .thumb-inner { filter:none; }

    .thumb::after {
      content:"Contenido desbloqueado ✓";
      position:absolute;
      bottom:6px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(34,197,94,0.85);
      color:#022c22;
      padding:2px 10px;
      border-radius:999px;
      font-size:0.7rem;
      opacity:0;
      pointer-events:none;
      transition:0.25s;
    }

    .thumb.unlocked::after { opacity:1; }

    .thumb video {
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:12px;
    }

    /* AUTH CARD */
    .auth-card {
      margin-top:24px;
      background:#020617;
      border:1px solid rgba(30,64,175,0.65);
      padding:16px;
      border-radius:12px;
    }

    .auth-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:10px;
    }

    .auth-title {
      font-size:0.95rem;
      font-weight:600;
    }

    .auth-toggle {
      font-size:0.8rem;
      color:#38bdf8;
      cursor:pointer;
      text-decoration:underline;
    }

    .auth-sub {
      font-size:0.8rem;
      color:rgba(148,163,184,0.95);
      margin-bottom:10px;
    }

    .auth-row {
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }

    .form-group { margin-bottom:10px; }

    label { display:block; margin-bottom:4px; font-size:0.85rem; }

    input {
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid rgba(148,163,184,0.85);
      background:#050b18;
      color:#e5e7eb;
      font-size:0.88rem;
      outline:none;
    }

    .btn-primary, .btn-secondary {
      padding:10px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      width:100%;
      margin-top:10px;
      font-size:0.9rem;
      font-weight:500;
    }

    .btn-primary { background:#22c55e; color:#022c22; }
    .btn-secondary { background:#0ea5e9; color:#02273b; }

    .auth-status {
      margin-top:8px;
      font-size:0.8rem;
      min-height:18px;
    }

    .user-bar {
      margin-top:10px;
      font-size:0.8rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    .user-bar button {
      padding:6px 10px;
      border-radius:999px;
      border:none;
      font-size:0.75rem;
      cursor:pointer;
      background:#ef4444;
      color:#fef2f2;
    }

    /* FORMULARIO PAGO */
    .pay-card {
      margin-top:26px;
      background:#020617;
      border:1px solid rgba(30,64,175,0.65);
      padding:16px;
      border-radius:12px;
    }

    #aliasBox {
      display:none;
      border:1px solid rgba(94,234,212,0.5);
      padding:10px;
      border-radius:10px;
      background:#042f2e;
      margin-top:12px;
      font-size:0.9rem;
    }

    #formStatus {
      margin-top:10px;
      font-size:0.85rem;
      min-height:20px;
    }

    footer {
      margin-top:auto;
      padding:14px;
      text-align:center;
      font-size:0.8rem;
      color:rgba(148,163,184,0.9);
      border-top:1px solid rgba(30,64,175,0.5);
    }
  </style>
</head>
<body>

<header>
  <img src="logocoffexxx.webp" class="logo" id="coffexLogo" alt="CoffeXXX">
  <h1>CoffeXXX</h1>
  <p>Contenido exclusivo · Suscripción mensual $80.000 ARS</p>
</header>

<main>

  <!-- AUTH -->
  <section id="authSection" class="auth-card">
    <div class="auth-header">
      <div class="auth-title" id="authTitle">Iniciar sesión</div>
      <div class="auth-toggle" id="authToggle">¿No tenés cuenta? Registrate</div>
    </div>
    <p class="auth-sub" id="authSub">
      Accedé a tu cuenta para gestionar tu suscripción CoffeXXX.
    </p>

    <div class="auth-row">
      <div class="form-group" id="authNameGroup" style="display:none;">
        <label>Nombre (para registro)</label>
        <input id="authName" type="text" placeholder="Tu nombre">
      </div>

      <div class="form-group">
        <label>Email</label>
        <input id="authEmail" type="email" placeholder="tuemail@ejemplo.com">
      </div>

      <div class="form-group">
        <label>Contraseña</label>
        <input id="authPass" type="password" placeholder="********">
      </div>
    </div>

    <button id="authSubmit" class="btn-secondary">Entrar</button>
    <div id="authStatus" class="auth-status"></div>
  </section>

  <!-- BARRA USER CUANDO ESTÁ LOGUEADO -->
  <div id="userBar" class="user-bar" style="display:none;">
    <span id="userInfo"></span>
    <button type="button" id="btnLogout">Cerrar sesión</button>
  </div>

  <!-- GALERÍA -->
  <h2 class="section-title" style="margin-top:24px;">Contenido exclusivo (6 fotos + 1 video)</h2>

  <div class="grid">
    <div class="thumb" data-type="image" data-hd="foto1.jpg">
      <div class="thumb-inner" style="background-image:url('foto1.jpg')"></div>
    </div>
    <div class="thumb" data-type="image" data-hd="foto2.jpg">
      <div class="thumb-inner" style="background-image:url('foto2.jpg')"></div>
    </div>
    <div class="thumb" data-type="image" data-hd="foto3.jpg">
      <div class="thumb-inner" style="background-image:url('foto3.jpg')"></div>
    </div>
    <div class="thumb" data-type="image" data-hd="foto4.jpg">
      <div class="thumb-inner" style="background-image:url('foto4.jpg')"></div>
    </div>
    <div class="thumb" data-type="image" data-hd="foto5.jpg">
      <div class="thumb-inner" style="background-image:url('foto5.jpg')"></div>
    </div>
    <div class="thumb" data-type="image" data-hd="foto6.jpg">
      <div class="thumb-inner" style="background-image:url('foto6.jpg')"></div>
    </div>

    <div class="thumb"
         data-type="video"
         data-video="video1.mp4"
         data-poster="foto1.jpg">
      <div class="thumb-inner" style="background-image:url('foto1.jpg')"></div>
    </div>
  </div>

  <!-- FORMULARIO PAGO (solo si está logueado) -->
  <section id="paySection" class="pay-card" style="display:none;">
    <h2 class="section-title" style="margin-top:0;">Solicitar acceso</h2>

    <form id="requestForm">
      <div class="form-group">
        <label>Nombre completo *</label>
        <input id="nombre" type="text" required>
      </div>

      <div class="form-group">
        <label>Contacto (Instagram / WhatsApp) *</label>
        <input id="contacto" type="text" required>
      </div>

      <div class="form-group" style="margin-top:10px;">
        <label><input type="checkbox" id="acepto"> Confirmo que soy mayor de edad *</label>
      </div>

      <button id="btnAlias" type="button" class="btn-secondary">
        Ver alias para pagar
      </button>

      <div id="aliasBox">
        <p><strong>Alias para pagar:</strong>
          <span style="color:#5eead4;">agusdente</span>
        </p>

        <p style="font-size:0.8rem; color:#a5f3fc; margin-top:6px;">
          <strong>Aclaración:</strong> Este alias pertenece al intermediario encargado de procesar los pagos.
          Una vez realizada la transferencia, el dinero se envía de manera automática y segura a la creadora <strong>Sofii</strong>.
        </p>

        <div class="form-group" style="margin-top:14px;">
          <label>Comprobante de pago (imagen o PDF) *</label>
          <input id="comprobanteFile" type="file" accept="image/*,application/pdf" required>
        </div>
      </div>

      <button type="submit" class="btn-primary">
        Enviar solicitud
      </button>

      <div id="formStatus"></div>
    </form>
  </section>

</main>

<footer>
  CoffeXXX © Contenido exclusivo · Suscripción mensual
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDnQKrLuArSTWwg98T5sBCPQuP7yWg5zUc",
    authDomain: "coffexxx-admin.firebaseapp.com",
    projectId: "coffexxx-admin",
    storageBucket: "coffexxx-admin.firebasestorage.app",
    messagingSenderId: "669030910916",
    appId: "1:669030910916:web:e170abf4663aec7bb1f291",
    measurementId: "G-7XR9SB1BGZ"
  };

  firebase.initializeApp(firebaseConfig);
  const auth    = firebase.auth();
  const db      = firebase.firestore();
  const storage = firebase.storage();

  const STORAGE_KEY = "coffexxx_request_v1";

  let aliasVisible = false;
  let unsubscribeDoc = null;
  let currentUser = null;

  /* -------- GALERÍA (DESBLOQUEO) -------- */
  function applyUnlockedState() {
    document.querySelectorAll(".thumb").forEach(thumb => {
      thumb.classList.add("unlocked");
      const type = thumb.dataset.type;

      if (type === "image") {
        const hd = thumb.dataset.hd;
        const inner = thumb.querySelector(".thumb-inner");
        if (inner && hd) inner.style.backgroundImage = "url('" + hd + "')";
      }

      if (type === "video") {
        const src = thumb.dataset.video;
        const poster = thumb.dataset.poster;
        thumb.innerHTML = `
          <video controls playsinline controlsList="nodownload"
                 poster="${poster || ''}">
            <source src="${src}" type="video/mp4">
          </video>
        `;
      }
    });
  }

  function listenToRequest(id) {
    if (!id) return;
    if (unsubscribeDoc) unsubscribeDoc();

    unsubscribeDoc = db.collection("suscripciones").doc(id)
      .onSnapshot(doc => {
        if (!doc.exists) return;
        const data = doc.data();
        if (data.desbloqueado) {
          applyUnlockedState();
          const status = document.getElementById("formStatus");
          if (status) {
            status.textContent = "Suscripción aprobada. Contenido desbloqueado ✓";
            status.style.color = "#4ade80";
          }
        }
      });
  }

  /* -------- AUTH UI -------- */
  const authSection = document.getElementById("authSection");
  const paySection  = document.getElementById("paySection");
  const userBar     = document.getElementById("userBar");
  const userInfo    = document.getElementById("userInfo");
  const btnLogout   = document.getElementById("btnLogout");

  const authTitle   = document.getElementById("authTitle");
  const authToggle  = document.getElementById("authToggle");
  const authSub     = document.getElementById("authSub");
  const authNameGrp = document.getElementById("authNameGroup");
  const authName    = document.getElementById("authName");
  const authEmail   = document.getElementById("authEmail");
  const authPass    = document.getElementById("authPass");
  const authSubmit  = document.getElementById("authSubmit");
  const authStatus  = document.getElementById("authStatus");

  let authMode = "login"; // "login" o "register"

  function updateAuthUI() {
    if (authMode === "login") {
      authTitle.textContent = "Iniciar sesión";
      authToggle.textContent = "¿No tenés cuenta? Registrate";
      authSub.textContent = "Accedé a tu cuenta para gestionar tu suscripción CoffeXXX.";
      authNameGrp.style.display = "none";
      authSubmit.textContent = "Entrar";
    } else {
      authTitle.textContent = "Crear cuenta";
      authToggle.textContent = "¿Ya tenés cuenta? Iniciar sesión";
      authSub.textContent = "Registrate con tu email para comprar la suscripción mensual.";
      authNameGrp.style.display = "block";
      authSubmit.textContent = "Registrarme";
    }
  }

  authToggle.addEventListener("click", () => {
    authMode = authMode === "login" ? "register" : "login";
    authStatus.textContent = "";
    updateAuthUI();
  });

  authSubmit.addEventListener("click", async () => {
    const email = authEmail.value.trim();
    const pass  = authPass.value.trim();
    const name  = authName.value.trim();

    authStatus.style.color = "#e5e7eb";

    if (!email || !pass || (authMode === "register" && !name)) {
      authStatus.textContent = "Completá los campos requeridos.";
      authStatus.style.color = "#f97373";
      return;
    }

    try {
      if (authMode === "login") {
        authStatus.textContent = "Iniciando sesión...";
        await auth.signInWithEmailAndPassword(email, pass);
        authStatus.textContent = "";
      } else {
        authStatus.textContent = "Creando cuenta...";
        const cred = await auth.createUserWithEmailAndPassword(email, pass);

        if (name) {
          await cred.user.updateProfile({ displayName: name });
        }

        // Guardar usuario en colección "usuarios"
        await db.collection("usuarios").doc(cred.user.uid).set({
          uid: cred.user.uid,
          nombre: name || null,
          email: email,
          creado: firebase.firestore.FieldValue.serverTimestamp()
        });

        authStatus.textContent = "Cuenta creada. Ya podés solicitar acceso.";
      }
    } catch (err) {
      console.error(err);
      authStatus.textContent = "Firebase: " + (err.message || "Error en autenticación.";
      authStatus.style.color = "#f97373";
    }
  });

  btnLogout.addEventListener("click", () => {
    auth.signOut();
  });

  auth.onAuthStateChanged(user => {
    currentUser = user;

    const status = document.getElementById("formStatus");
    if (status) {
      status.textContent = "";
      status.style.color = "#e5e7eb";
    }

    if (user) {
      authSection.style.display = "none";
      paySection.style.display  = "block";
      userBar.style.display     = "flex";
      userInfo.textContent      = `Conectado como ${user.email}`;

      const existing = localStorage.getItem(STORAGE_KEY);
      if (existing) listenToRequest(existing);
    } else {
      authSection.style.display = "block";
      paySection.style.display  = "none";
      userBar.style.display     = "none";
      aliasVisible = false;
      document.getElementById("aliasBox").style.display = "none";
    }
  });

  /* -------- FORM PAGO -------- */
  document.addEventListener("DOMContentLoaded", () => {
    const existing = localStorage.getItem(STORAGE_KEY);
    if (existing) listenToRequest(existing);

    const btnAlias = document.getElementById("btnAlias");
    const form = document.getElementById("requestForm");
    const status = document.getElementById("formStatus");

    btnAlias.addEventListener("click", () => {
      if (!currentUser) {
        status.textContent = "Primero iniciá sesión o registrate.";
        status.style.color = "#f97373";
        return;
      }

      const nombre = document.getElementById("nombre").value.trim();
      const contacto = document.getElementById("contacto").value.trim();
      const acepto = document.getElementById("acepto").checked;

      if (!nombre || !contacto || !acepto) {
        status.textContent = "Completá nombre, contacto y tildá que sos mayor de edad.";
        status.style.color = "#f97373";
        return;
      }

      document.getElementById("aliasBox").style.display = "block";
      aliasVisible = true;
      status.textContent = "Alias mostrado. Realizá el pago y adjuntá el comprobante.";
      status.style.color = "#5eead4";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nombre = document.getElementById("nombre").value.trim();
      const contacto = document.getElementById("contacto").value.trim();
      const acepto = document.getElementById("acepto").checked;
      const fileInput = document.getElementById("comprobanteFile");
      const file = fileInput.files[0];

      if (!currentUser) {
        status.textContent = "Primero iniciá sesión o registrate.";
        status.style.color = "#f97373";
        return;
      }

      if (!aliasVisible) {
        status.textContent = "Primero tocá 'Ver alias para pagar'.";
        status.style.color = "#f97373";
        return;
      }

      if (!nombre || !contacto || !acepto || !file) {
        status.textContent = "Completá todos los campos y adjuntá el comprobante.";
        status.style.color = "#f97373";
        return;
      }

      status.textContent = "Subiendo comprobante y enviando solicitud...";
      status.style.color = "#e5e7eb";

      try {
        const filePath = "comprobantes/" + currentUser.uid + "_" + Date.now() + "_" + file.name;
        const fileRef = storage.ref().child(filePath);
        const snap = await fileRef.put(file);
        const url = await snap.ref.getDownloadURL();

        const ref = await db.collection("suscripciones").add({
          uid: currentUser.uid,
          emailUsuario: currentUser.email,
          nombre,
          contacto,
          comprobanteUrl: url,
          comprobanteNombre: file.name,
          comprobantePath: filePath,
          creado: firebase.firestore.FieldValue.serverTimestamp(),
          origen: "CoffeXXX",
          monto: 80000,
          moneda: "ARS",
          desbloqueado: false
        });

        localStorage.setItem(STORAGE_KEY, ref.id);
        listenToRequest(ref.id);

        status.textContent = "Solicitud enviada. Se desbloqueará cuando el admin la apruebe.";
        status.style.color = "#4ade80";
      } catch (err) {
        console.error(err);
        status.textContent = "Error al enviar la solicitud. Intentá de nuevo.";
        status.style.color = "#f97373";
      }
    });
  });

  // Inicializar textos de login/registro
  updateAuthUI();
</script>

</body>
</html>
